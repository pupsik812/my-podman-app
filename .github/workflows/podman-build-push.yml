---
name: Build and push with Podman


on:
  push:
    branches: ["main"]


jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
      - run: echo "Setup"
  build:
    needs: setup
    steps:
      - run: echo "Build"


    - name: Install Podman
      run: |
          sudo apt-get update
          sudo apt-get install -y podman podman-docker buildah
          sudo mkdir -p /etc/containers
          echo -e '[registries.search]\nregistries = ["docker.io"]' | sudo tee /etc/containers/registries.conf

          echo "podman:100000:65536" | sudo tee /etc/subuid
          echo "podman:100000:65536" | sudo tee /etc/subgid
          mkdir -p ~/.local/share/containers
          chmod 755 ~/.local/share/containers


    - name: Verify Podman
       run: |
         podman --version
         buildah --version


    - name: Configure Docker Hub auth
      run: |
          mkdir -p ~/.docker
          auth_token=$( echo -n"${{ secrets.DOCKERHUB_USERNAME }}:${{ secrets.DOCKERHUB_TOKEN }}" \
             | base64 -w0)
          echo "{\"auths\":{\"docker.io\":{\"auth\":\"${auth_token}\"}}}" \
             > ~/.docker/config.json
          chmod 600 ~/..docker/config.json


     - name: Build and push image
        env:
          DOCKERHUB_USER: ${{ secrets.DOCKERHUB_USERNAME}}
        run: |
          podman build \
            -t "docker.io/${{ secrets.DOCKERHUB_USERNAME }}/my-podman-app:latest" .
          podman push \
            "docker.io/${{ secrets.DOCKERHUB_USERNAME }}/my-podman-app:latest"
